<?php
namespace app\sg\controller\Server;

use Workerman\Worker;
use PHPSocketIO\SocketIO;
use Workerman\Lib\Timer;
use think\Controller;
use think\Db;
use app\common\udp\AnalyzeData;
use util;

class Core extends Controller
{
    protected $socket;
    protected $config_index = NULL;

    public function index($config_index)
    {
        $this->config_index = $config_index;
        $config = config('db_config')[ $this->config_index ];
        $this->socket = new SocketIO($config['socketio']['port']);
        $this->socket->on('workerStart', function($socket)use($config){
            Timer::add(1,function()use($config){
                if( $config['DB_DATA'] ){
                    $data = json_encode($this->getDataFromDB());
                }else{
                    $data = json_encode($this->analyzeUDP());
                }
                $this->socket->emit('AnalyUdpData' . $this->config_index,$data );
            });
        });
        $this->socket->on('disconnect', function($socket){
            var_dump('disconnect');
        });
        Worker::runAll();
    }

    protected function analyzeUDP()
    {
        return AnalyzeData::analyzeUdp($this->config_index);
    }

    protected function getDataFromDB()
    {
        $config = config('db_config')[ $this->config_index ];
        $connect = util::getConnect($config);
        //$data = Db::connect($connect)->table('proddata')->where('id',1)->value('data');
        $data = '0xD01B0500010000009F080000220B00003A000000A20300005870280000000000000000002D000000A2030000C1130000A2030000FC4D1F002675280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002C010000D200000060000000000000006C07000058702800F09000000E340000E25C0000420000001E6B0000386900007F000000E60100002E000000B100000002040000581A000019040000040000005F120000040800005A0A0000360000003A0F00000D0F0000660000002D00000005010000730000006602000025070000B10000000200000000000000600000000000000048EE0000000000000000000074822700E414CF00540000006C07000022C34700E8030000540000000807000015E50500E803000000000000000000000000000078E6000000000000000000000000000000000000330000006C07000029DF2900E60400002D00000000000000000000000000000000000000000000000000000078E6000000000000000000000000000000000000380000006C07000029DF2900E80300002D00000000000000000000000000000000000000000000000000000098DD020000000000000000001A306D002E6D2001330000006C0700006BA571005C050000330000000807000015E505005C05000000000000640000006500000098DD02000000000000000000249325003039D200570000006C07000022C34700E8030000460000006C07000029DF2900E80300000000000000000000000000000CBF020000000000000000005733FCFF3D06C200330000000807000015E50500BC050000310000000807000040AF0B00BC0500000000000000000000000000000CBF02000000000000000000F440FDFF502B8400460000000807000015E50500E8030000410000000807000040AF0B00E803000041000000323032312D30332D31312030383A3436000000000000000000000000751D00000A0000005A0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C0000006A000000010000000100000000000000010000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000001E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004201000000000000000000000000000000000000000000000000000000000000000000005824000000000000';
        $data = substr(str_replace(" ", '', $data), 2);
        return AnalyzeData::analyzeUdp( $this->config_index, $this->byteTostr($data) );
    }

    protected function byteTostr($hex)
    {
        $str = '';
        for( $i = 0; $i < strlen( $hex ) - 1; $i += 2 ){
            $str .= chr( hexdec( $hex[ $i ].$hex[ $i + 1 ] ) );
        }
        return $str;
    }
}


